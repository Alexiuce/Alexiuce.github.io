<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Runloopå†…éƒ¨åˆ†äº« | æ±‚çŸ¥è‹¥æ¸´ å¤§æ™ºè‹¥æ„š</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Let us runloop
Runloop ç®€ä»‹
runloop å°±æ˜¯ OSX/iOS ç³»ç»Ÿä¸­çš„æ¶ˆæ¯å¾ªç¯æœºåˆ¶ï¼Œç±»ä¼¼Windowsç»ˆç«¯ Event loop ï¼ˆäº‹ä»¶å¾ªç¯ï¼‰ã€‚åœ¨OSXå’ŒiOSä¸­ï¼Œç³»ç»Ÿæä¾›äº†ä¸¤ä¸ªè¿™æ ·çš„å¯¹è±¡ï¼šNSRunLoop å’Œ CFRunLoopRefã€‚ CFRunLoopRef æ˜¯åœ¨ CoreFoundation æ¡†æ¶å†…çš„ï¼Œå®ƒæä¾›äº†çº¯ C å‡½æ•°çš„ APIï¼Œæ‰€æœ‰è¿™äº› API éƒ½æ˜¯çº¿ç¨‹">
<meta property="og:type" content="article">
<meta property="og:title" content="Runloopå†…éƒ¨åˆ†äº«">
<meta property="og:url" content="http://yoursite.com/2016/04/11/Runloopå†…éƒ¨åˆ†äº«/index.html">
<meta property="og:site_name" content="æ±‚çŸ¥è‹¥æ¸´ å¤§æ™ºè‹¥æ„š">
<meta property="og:description" content="Let us runloop
Runloop ç®€ä»‹
runloop å°±æ˜¯ OSX/iOS ç³»ç»Ÿä¸­çš„æ¶ˆæ¯å¾ªç¯æœºåˆ¶ï¼Œç±»ä¼¼Windowsç»ˆç«¯ Event loop ï¼ˆäº‹ä»¶å¾ªç¯ï¼‰ã€‚åœ¨OSXå’ŒiOSä¸­ï¼Œç³»ç»Ÿæä¾›äº†ä¸¤ä¸ªè¿™æ ·çš„å¯¹è±¡ï¼šNSRunLoop å’Œ CFRunLoopRefã€‚ CFRunLoopRef æ˜¯åœ¨ CoreFoundation æ¡†æ¶å†…çš„ï¼Œå®ƒæä¾›äº†çº¯ C å‡½æ•°çš„ APIï¼Œæ‰€æœ‰è¿™äº› API éƒ½æ˜¯çº¿ç¨‹">
<meta property="og:image" content="http://ww4.sinaimg.cn/large/46f12941gw1f2ster7puej21380a6wg0.jpg">
<meta property="og:image" content="http://ww3.sinaimg.cn/large/46f12941gw1f2stfjy7m9j206u056q32.jpg">
<meta property="og:image" content="http://ww3.sinaimg.cn/large/46f12941gw1f2stfzgci8j20bl08t0uf.jpg">
<meta property="og:updated_time" content="2016-04-11T08:06:42.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Runloopå†…éƒ¨åˆ†äº«">
<meta name="twitter:description" content="Let us runloop
Runloop ç®€ä»‹
runloop å°±æ˜¯ OSX/iOS ç³»ç»Ÿä¸­çš„æ¶ˆæ¯å¾ªç¯æœºåˆ¶ï¼Œç±»ä¼¼Windowsç»ˆç«¯ Event loop ï¼ˆäº‹ä»¶å¾ªç¯ï¼‰ã€‚åœ¨OSXå’ŒiOSä¸­ï¼Œç³»ç»Ÿæä¾›äº†ä¸¤ä¸ªè¿™æ ·çš„å¯¹è±¡ï¼šNSRunLoop å’Œ CFRunLoopRefã€‚ CFRunLoopRef æ˜¯åœ¨ CoreFoundation æ¡†æ¶å†…çš„ï¼Œå®ƒæä¾›äº†çº¯ C å‡½æ•°çš„ APIï¼Œæ‰€æœ‰è¿™äº› API éƒ½æ˜¯çº¿ç¨‹">
  
    <link rel="alternative" href="/atom.xml" title="æ±‚çŸ¥è‹¥æ¸´ å¤§æ™ºè‹¥æ„š" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link rel="stylesheet" href="/css/style.css" type="text/css">
</head>
<body>
  <div id="container">
    <div class="left-col">
    <div class="overlay"></div>
<div class="intrude-less">
	<header id="header" class="inner">
		<a href="/" class="profilepic">
			
			<img lazy-src="http://ww4.sinaimg.cn/large/46f12941gw1etv5n2xxa3j21hc0u0gos.jpg" class="js-avatar">
			
		</a>

		<hgroup>
		  <h1 class="header-author"><a href="/">Alexcai</a></h1>
		</hgroup>

		
		<p class="header-subtitle">è€èœå±…å£«</p>
		

		
			<div class="switch-btn">
				<div class="icon">
					<div class="icon-ctn">
						<div class="icon-wrap icon-house" data-idx="0">
							<div class="birdhouse"></div>
							<div class="birdhouse_holes"></div>
						</div>
						<div class="icon-wrap icon-ribbon hide" data-idx="1">
							<div class="ribbon"></div>
						</div>
						
						<div class="icon-wrap icon-link hide" data-idx="2">
							<div class="loopback_l"></div>
							<div class="loopback_r"></div>
						</div>
						
						
						<div class="icon-wrap icon-me hide" data-idx="3">
							<div class="user"></div>
							<div class="shoulder"></div>
						</div>
						
					</div>
					
				</div>
				<div class="tips-box hide">
					<div class="tips-arrow"></div>
					<ul class="tips-inner">
						<li>èœå•</li>
						<li>æ ‡ç­¾</li>
						
						<li>å‹æƒ…é“¾æ¥</li>
						
						
						<li>å…³äºæˆ‘</li>
						
					</ul>
				</div>
			</div>
		

		<div class="switch-area">
			<div class="switch-wrap">
				<section class="switch-part switch-part1">
					<nav class="header-menu">
						<ul>
						
							<li><a href="/">ä¸»é¡µ</a></li>
				        
							<li><a href="/archives">æ‰€æœ‰æ–‡ç« </a></li>
				        
						</ul>
					</nav>
					<nav class="header-nav">
						<div class="social">
							
								<a class="github" target="_blank" href="https://github.com/leiocai" title="github">github</a>
					        
								<a class="weibo" target="_blank" href="http://weibo.com/u/1190209857?from=hissimilar_home" title="weibo">weibo</a>
					        
								<a class="rss" target="_blank" href="/#" title="rss">rss</a>
					        
								<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
					        
						</div>
					</nav>
				</section>
				
				
				<section class="switch-part switch-part2">
					<div class="widget tagcloud" id="js-tagcloud">
						<a href="/tags/Gitç›¸å…³/" style="font-size: 10px;">Gitç›¸å…³</a> <a href="/tags/Objective-C/" style="font-size: 16.67px;">Objective-C</a> <a href="/tags/hexo/" style="font-size: 13.33px;">hexo</a> <a href="/tags/iOS/" style="font-size: 10px;">iOS</a> <a href="/tags/iOSå¼€å‘/" style="font-size: 10px;">iOSå¼€å‘</a> <a href="/tags/iOSæŠ€å·§/" style="font-size: 10px;">iOSæŠ€å·§</a> <a href="/tags/ä¸»é¢˜/" style="font-size: 20px;">ä¸»é¢˜</a>
					</div>
				</section>
				
				
				
				<section class="switch-part switch-part3">
					<div id="js-friends">
					
			          <a target="_blank" class="main-nav-link switch-friends-link" href="http://www.keyed.cn/">å¤©æ˜çš„åšå®¢</a>
			        
			        </div>
				</section>
				

				
				
				<section class="switch-part switch-part4">
				
					<div id="js-aboutme">è¿›æ­¥,å°±æ˜¯æ¯å¤©é‡åˆ°æ›´å¥½çš„è‡ªå·±!</div>
				</section>
				
			</div>
		</div>
	</header>				
</div>
    </div>
    <div class="mid-col">
      <nav id="mobile-nav">
  	<div class="overlay">
  		<div class="slider-trigger"></div>
  		<h1 class="header-author js-mobile-header hide">Alexcai</h1>
  	</div>
	<div class="intrude-less">
		<header id="header" class="inner">
			<div class="profilepic">
				<img lazy-src="http://ww4.sinaimg.cn/large/46f12941gw1etv5n2xxa3j21hc0u0gos.jpg" class="js-avatar">
			</div>
			<hgroup>
			  <h1 class="header-author">Alexcai</h1>
			</hgroup>
			
			<p class="header-subtitle">è€èœå±…å£«</p>
			
			<nav class="header-menu">
				<ul>
				
					<li><a href="/">ä¸»é¡µ</a></li>
		        
					<li><a href="/archives">æ‰€æœ‰æ–‡ç« </a></li>
		        
		        <div class="clearfix"></div>
				</ul>
			</nav>
			<nav class="header-nav">
				<div class="social">
					
						<a class="github" target="_blank" href="https://github.com/leiocai" title="github">github</a>
			        
						<a class="weibo" target="_blank" href="http://weibo.com/u/1190209857?from=hissimilar_home" title="weibo">weibo</a>
			        
						<a class="rss" target="_blank" href="/#" title="rss">rss</a>
			        
						<a class="zhihu" target="_blank" href="/#" title="zhihu">zhihu</a>
			        
				</div>
			</nav>
		</header>				
	</div>
</nav>
      <div class="body-wrap"><article id="post-Runloopå†…éƒ¨åˆ†äº«" class="article article-type-post" itemscope itemprop="blogPost">
  
    <div class="article-meta">
      <a href="/2016/04/11/Runloopå†…éƒ¨åˆ†äº«/" class="article-date">
  	<time datetime="2016-04-11T08:05:35.000Z" itemprop="datePublished">2016-04-11</time>
</a>
    </div>
  
  <div class="article-inner">
    
      <input type="hidden" class="isFancy" />
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Runloopå†…éƒ¨åˆ†äº«
    </h1>
  

      </header>
      
      <div class="article-info article-info-post">
        
        

        <div class="clearfix"></div>
      </div>
      
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Let_us_runloop">Let us runloop</h1><p><img src="http://ww4.sinaimg.cn/large/46f12941gw1f2ster7puej21380a6wg0.jpg" alt=""></p>
<h2 id="Runloop_ç®€ä»‹">Runloop ç®€ä»‹</h2><blockquote>
<h3 id="runloop_å°±æ˜¯_OSX/iOS_ç³»ç»Ÿä¸­çš„æ¶ˆæ¯å¾ªç¯æœºåˆ¶ï¼Œç±»ä¼¼Windowsç»ˆç«¯_Event_loop_ï¼ˆäº‹ä»¶å¾ªç¯ï¼‰ã€‚">runloop å°±æ˜¯ OSX/iOS ç³»ç»Ÿä¸­çš„æ¶ˆæ¯å¾ªç¯æœºåˆ¶ï¼Œç±»ä¼¼Windowsç»ˆç«¯ Event loop ï¼ˆäº‹ä»¶å¾ªç¯ï¼‰ã€‚</h3><h3 id="åœ¨OSXå’ŒiOSä¸­ï¼Œç³»ç»Ÿæä¾›äº†ä¸¤ä¸ªè¿™æ ·çš„å¯¹è±¡ï¼šNSRunLoop_å’Œ_CFRunLoopRefã€‚">åœ¨OSXå’ŒiOSä¸­ï¼Œç³»ç»Ÿæä¾›äº†ä¸¤ä¸ªè¿™æ ·çš„å¯¹è±¡ï¼šNSRunLoop å’Œ CFRunLoopRefã€‚</h3><p> CFRunLoopRef æ˜¯åœ¨ CoreFoundation æ¡†æ¶å†…çš„ï¼Œå®ƒæä¾›äº†çº¯ C å‡½æ•°çš„ APIï¼Œæ‰€æœ‰è¿™äº› API éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p>
<p>NSRunLoop æ˜¯åŸºäº CFRunLoopRef çš„å°è£…ï¼Œæä¾›äº†é¢å‘å¯¹è±¡çš„ APIï¼Œä½†æ˜¯è¿™äº› API ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ </p>
<ul>
<li>NSRunloop ç”¨æ¥ç®¡ç†ç³»ç»Ÿçš„è¾“å…¥æºäº‹ä»¶çš„ï¼ŒåŒ…æ‹¬çª—å£çš„é¼ æ ‡ï¼ˆiOSä¸Šä¸ºè§¦æ‘¸ï¼‰å’Œé”®ç›˜äº‹ä»¶ã€NSPortï¼ˆçº¿ç¨‹é—´é€šä¿¡ï¼‰ã€NSConnection(ç½‘ç»œè¯·æ±‚)ä»¥åŠNSTimerï¼ˆå«CADisplayLinkï¼‰äº‹ä»¶ã€‚</li>
<li><h4 id="WARNINGï¼ˆè‹¹æœå®˜æ–¹åŸæ–‡ï¼‰">WARNINGï¼ˆè‹¹æœå®˜æ–¹åŸæ–‡ï¼‰</h4>The NSRunLoop class is generally not considered to be thread-safe and its methods should only be called within the context of the current thread. You should never try to call the methods of an NSRunLoop object running in a different thread, as doing so might cause unexpected results.</li>
<li><h4 id="è­¦å‘Šï¼ˆç§€ç­–åˆ†äº«è¯‘æ–‡ï¼‰">è­¦å‘Šï¼ˆç§€ç­–åˆ†äº«è¯‘æ–‡ï¼‰</h4>å˜¿ï¼Œçº¿ç¨‹ï¼Œæˆ‘ï¼ˆNSRunLoopï¼‰æ²¡é‚£ä¹ˆå¥½è„¾æ°”ï¼å¹¶ä¸”åªåœ¨ç‰¹å®šçš„ç¯å¢ƒä¸­ï¼ˆå½“å‰çº¿ç¨‹ï¼‰æ‰å¹²æ´»ï¼Œä½ æ°¸è¿œåˆ«æƒ³å¼„ä¸ªå…¶ä»–ç¯å¢ƒï¼ˆçº¿ç¨‹ï¼‰å‹¾æ­æˆ‘ï¼ˆè°ƒç”¨æ–¹æ³•ï¼‰ï¼Œä¸ç„¶ï¼Œå°±ç«‹é©¬æ­»ç»™ä½ çœ‹ã€‚</li>
</ul>
</blockquote>
<h2 id="Runloop_ç‰¹æ€§">Runloop ç‰¹æ€§</h2><ul>
<li>ä¸èƒ½æ‰‹åŠ¨åˆ›å»ºï¼Œåªèƒ½è·å–ï¼ˆä¼ è¯´ä¸­çš„ä¸åŠ³è€Œè·ï¼ŸğŸ¤—ï¼‰ã€‚</li>
<li>å†…éƒ¨è‡ªå¸¦æ­»å¾ªç¯ï¼ˆä¿¡runloopï¼Œå¾—æ°¸ç”ŸğŸ˜‡ï¼‰ã€‚</li>
<li>ä¸€ä¸ªçº¿ç¨‹å†…éƒ¨ï¼Œå¯„ç”Ÿç€å”¯ä¸€çš„ä¸€ä¸ªrunloopï¼ˆå¯„ç”Ÿè™«ï¼ŸğŸ›ï¼‰ã€‚</li>
<li>æ‡’åŠ è½½ï¼ˆä½ ä¸è¯´è¦ï¼Œæˆ‘å°±ä¸ç»™ğŸ¤“ï¼‰ã€‚</li>
<li>ä¸€ä¸ªrunloopå¯ä»¥æœ‰è‹¥å¹²çš„Modeï¼ˆè¿è¡Œæ¨¡å¼ï¼šï¼‰ï¼Œä½†æ¯æ¬¡åªèƒ½åœ¨ä¸€ä¸ªModeä¸‹è¿è¡Œã€‚</li>
</ul>
<p><img src="http://ww3.sinaimg.cn/large/46f12941gw1f2stfjy7m9j206u056q32.jpg" alt=""></p>
<ul>
<li>å¦‚æœmodeï¼ˆæ— sourceï¼Œtimerï¼Œobserverï¼‰ä¸ºç©ºï¼Œrunloopå°†ç›´æ¥é€€å‡ºï¼ˆä¸ç»™å·¥èµ„å°±é—ªäººğŸ™„ï¼‰ã€‚</li>
<li>runloopå†…éƒ¨çš„Mode åªèƒ½å¢åŠ ï¼Œä¸èƒ½åˆ é™¤ã€‚</li>
</ul>
<h2 id="Runloop_é€»è¾‘ï¼ˆç½‘å‹æ•´ç†ç‰ˆï¼‰">Runloop é€»è¾‘ï¼ˆç½‘å‹æ•´ç†ç‰ˆï¼‰</h2><p><img src="http://ww3.sinaimg.cn/large/46f12941gw1f2stfzgci8j20bl08t0uf.jpg" alt="1432798974517485.png"></p>
<h2 id="Runloop_ä½œç”¨">Runloop ä½œç”¨</h2><ul>
<li>ä¿æŒç¨‹åºçš„æŒç»­è¿è¡Œã€‚</li>
<li>å¤„ç†äº‹ä»¶ä»»åŠ¡ã€‚</li>
<li>æé«˜ç³»ç»Ÿæ€§èƒ½ï¼ŒèŠ‚çœCPUèµ„æºã€‚</li>
<li>â€¦â€¦</li>
</ul>
<h2 id="Runloop_ä»£ç å®ä¾‹">Runloop ä»£ç å®ä¾‹</h2><ul>
<li>ä»»åŠ¡å»¶æ—¶åŠ è½½</li>
<li>çº¿ç¨‹å¸¸é©»å†…å­˜</li>
<li>NSTimerå®šæ—¶å™¨</li>
</ul>
<h2 id="Runloop_æºç éƒ¨åˆ†">Runloop æºç éƒ¨åˆ†</h2><h3 id="Runloop_æ•°æ®ç»“æ„ï¼š">Runloop æ•°æ®ç»“æ„ï¼š</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> __CFRunLoop &#123;</span><br><span class="line">CFRuntimeBase _base;      <span class="comment">// è®¾ç½®runloop åŸºæœ¬æ•°æ®çŠ¶æ€ï¼šç¡çœ ï¼Œé‡Šæ”¾ï¼ˆé”€æ¯ï¼‰ï¼Œä¹Ÿç”¨äºè®¡ç®—å†…éƒ¨modeå†…å­˜ç©ºé—´  </span></span><br><span class="line"><span class="keyword">pthread_mutex_t</span> _lock;		<span class="comment">// çº¿ç¨‹é”</span></span><br><span class="line">__CFPort _wakeUpPort;			<span class="comment">// å”¤é†’ç«¯å£ </span></span><br><span class="line">Boolean _unused;          <span class="comment">// æ˜¯å¦å¯ç”¨</span></span><br><span class="line"><span class="keyword">volatile</span> _per_run_data *_perRunData;   <span class="comment">// è®¾ç½®runloopï¼ˆçŠ¶æ€ï¼‰æ•°æ®ï¼šå¿½ç•¥å”¤é†’ï¼Œåœæ­¢</span></span><br><span class="line"><span class="keyword">pthread_t</span> _pthread;                <span class="comment">// çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">uint32_t</span> _winthread;               <span class="comment">// windows çº¿ç¨‹ï¼Œéwindowsç¯å¢ƒä¸‹ï¼Œè¯¥å­—ç«¯å§‹ç»ˆä¸º0</span></span><br><span class="line">CFMutableSetRef _commonModes;      <span class="comment">// common mode å¯å˜é›†åˆ</span></span><br><span class="line">CFMutableSetRef _commonModeItems;   <span class="comment">// common item å¯å˜é›†åˆ</span></span><br><span class="line">CFRunLoopModeRef _currentMode;       <span class="comment">// å½“å‰mode</span></span><br><span class="line">CFMutableSetRef _modes;             <span class="comment">// mode é›†åˆ    </span></span><br><span class="line"><span class="keyword">struct</span> _block_item *_blocks_head;    <span class="comment">// _block_item é“¾è¡¨å¤´ï¼ˆä»»åŠ¡é“¾è¡¨ï¼‰</span></span><br><span class="line"><span class="keyword">struct</span> _block_item *<span class="keyword">_blocks_t</span>ail;   <span class="comment">//  _block_item é“¾è¡¨å°¾ï¼ˆä»»åŠ¡é“¾è¡¨ï¼‰</span></span><br><span class="line">CFTypeRef _counterpart;             <span class="comment">// runloopç›¸å…³æ•°æ®ï¼ˆvoid * ç±»å‹ï¼Œç›¸å½“äºOCä¸­çš„idç±»å‹ï¼‰ï¼Œç”¨äºå¹¶å‘å¤šçº¿ç¨‹ ç±»ä¼¼å¤šçº¿ç¨‹å†…éƒ¨çš„TSDæ•°æ®           </span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Runloopçš„åˆ›å»ºæ–¹æ³•ï¼š">Runloopçš„åˆ›å»ºæ–¹æ³•ï¼š</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span><br><span class="line">*  åˆ›å»ºrunloop</span><br><span class="line">*</span><br><span class="line">*  @param t çº¿ç¨‹å‚æ•°</span><br><span class="line">*</span><br><span class="line">*  @return åˆ›å»ºå¥½çš„runloop</span><br><span class="line">*/</span></span><br><span class="line"><span class="keyword">static</span> CFRunLoopRef __CFRunLoopCreate(<span class="keyword">pthread_t</span> t) &#123;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ– runloop ä¸ºç©º</span></span><br><span class="line">CFRunLoopRef loop = NULL;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ– runloop mode</span></span><br><span class="line">CFRunLoopModeRef rlm;</span><br><span class="line"><span class="comment">// è®¡ç®— runloop å®ä¾‹çš„å†…å­˜ç©ºé—´</span></span><br><span class="line"><span class="keyword">uint32_t</span> size = <span class="keyword">sizeof</span>(<span class="keyword">struct</span> __CFRunLoop) - <span class="keyword">sizeof</span>(CFRuntimeBase);</span><br><span class="line"><span class="comment">// è°ƒç”¨runtimeå‡½æ•°ï¼Œåˆ›å»ºå®ä¾‹</span></span><br><span class="line">loop = (CFRunLoopRef)_CFRuntimeCreateInstance(kCFAllocatorSystemDefault, __kCFRunLoopTypeID, size, NULL);</span><br><span class="line"><span class="comment">// å¦‚æœåˆ›å»ºå¤±è´¥ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line"><span class="keyword">if</span> (NULL == loop) &#123;</span><br><span class="line"><span class="keyword">return</span> NULL;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å‹æ ˆæ•°æ®ï¼Œåˆå§‹åŒ–runloopçš„æ•°æ®çŠ¶æ€</span></span><br><span class="line">(<span class="keyword">void</span>)__CFRunLoopPushPerRunData(loop);</span><br><span class="line"><span class="comment">// è®¾ç½® runloop çš„çº¿ç¨‹é”</span></span><br><span class="line">__CFRunLoopLockInit(&amp;loop-&gt;_lock);</span><br><span class="line"><span class="comment">// è®¾ç½® runloop å”¤é†’ç«¯å£</span></span><br><span class="line">loop-&gt;_wakeUpPort = __CFPortAllocate();</span><br><span class="line"><span class="comment">// å¦‚æœè®¾ç½®å”¤é†’ç«¯å£å¤±è´¥ï¼Œç»ˆæ­¢å¹¶æŠ¥é”™</span></span><br><span class="line"><span class="keyword">if</span> (CFPORT_NULL == loop-&gt;_wakeUpPort) HALT;</span><br><span class="line"><span class="comment">// è®¾ç½® runloop çš„å¿½ç•¥å”¤é†’</span></span><br><span class="line">__CFRunLoopSetIgnoreWakeUps(loop);</span><br><span class="line"><span class="comment">// åˆ›å»ºcommon Mode å¯å˜é›†åˆ</span></span><br><span class="line">loop-&gt;_commonModes = CFSetCreateMutable(kCFAllocatorSystemDefault, <span class="number">0</span>, &amp;kCFTypeSetCallBacks);</span><br><span class="line"><span class="comment">// è®¾ç½®commom mode å€¼ï¼škCFRunLoopDefaultMode</span></span><br><span class="line">CFSetAddValue(loop-&gt;_commonModes, kCFRunLoopDefaultMode);</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–item</span></span><br><span class="line">loop-&gt;_commonModeItems = NULL;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ– current Mode</span></span><br><span class="line">loop-&gt;_currentMode = NULL;</span><br><span class="line"><span class="comment">// åˆ›å»º mode å¯å˜é›†åˆ</span></span><br><span class="line">loop-&gt;_modes = CFSetCreateMutable(kCFAllocatorSystemDefault, <span class="number">0</span>, &amp;kCFTypeSetCallBacks);</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–ä»»åŠ¡é“¾è¡¨</span></span><br><span class="line">loop-&gt;_blocks_head = NULL;</span><br><span class="line">loop-&gt;<span class="keyword">_blocks_t</span>ail = NULL;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ– å¯¹ç­‰æ•°æ®</span></span><br><span class="line">loop-&gt;_counterpart = NULL;</span><br><span class="line"><span class="comment">// æ ¹æ®ä¼ å…¥çš„çº¿ç¨‹ï¼Œè®¾ç½® runloop çš„çº¿ç¨‹</span></span><br><span class="line">loop-&gt;_pthread = t;</span><br><span class="line"><span class="comment">// windows ç¯å¢ƒ</span></span><br><span class="line"><span class="preprocessor">#<span class="keyword">if</span> DEPLOYMENT_TARGET_WINDOWS</span></span><br><span class="line">loop-&gt;_winthread = GetCurrentThreadId();</span><br><span class="line"><span class="preprocessor">#<span class="keyword">else</span></span></span><br><span class="line"><span class="comment">// éwindows ç¯å¢ƒ</span></span><br><span class="line">loop-&gt;_winthread = <span class="number">0</span>;</span><br><span class="line"><span class="preprocessor">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="comment">// å…ˆæŸ¥æ‰¾mode ï¼Œå¦‚æœæ²¡æœ‰ï¼Œåˆ™æ ¹æ®å‚æ•°ï¼ˆtrueï¼‰åˆ›å»ºmode</span></span><br><span class="line">rlm = __CFRunLoopFindMode(loop, kCFRunLoopDefaultMode, <span class="keyword">true</span>);</span><br><span class="line"><span class="comment">// å»é™¤ runloop mode çš„åŒæ­¥é”</span></span><br><span class="line"><span class="keyword">if</span> (NULL != rlm) __CFRunLoopModeUnlock(rlm);</span><br><span class="line"><span class="comment">// è¿”å› runloop</span></span><br><span class="line"><span class="keyword">return</span> loop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="è·å–Runloopæ–¹æ³•ï¼š">è·å–Runloopæ–¹æ³•ï¼š</h3><blockquote>
<h5 id="CFRunLoopGetMain_è·å–ä¸»çº¿ç¨‹çš„runloop">CFRunLoopGetMain è·å–ä¸»çº¿ç¨‹çš„runloop</h5></blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">CFRunLoopRef <span class="title">CFRunLoopGetMain</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">CHECK_FOR_FORK();</span><br><span class="line"><span class="keyword">static</span> CFRunLoopRef __main = NULL; <span class="comment">// no retain needed</span></span><br><span class="line"><span class="keyword">if</span> (!__main) __main = _CFRunLoopGet0(<span class="keyword">pthread_main_t</span>hread_np()); <span class="comment">// no CAS needed</span></span><br><span class="line"><span class="keyword">return</span> __main;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<h5 id="CFRunLoopGetCurrent_è·å–å½“å‰çº¿ç¨‹çš„runloop">CFRunLoopGetCurrent è·å–å½“å‰çº¿ç¨‹çš„runloop</h5></blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">CFRunLoopRef <span class="title">CFRunLoopGetCurrent</span><span class="params">(<span class="keyword">void</span>)</span> </span>&#123;</span><br><span class="line">CHECK_FOR_FORK();</span><br><span class="line">CFRunLoopRef rl = (CFRunLoopRef)_CFGetTSD(__CFTSDKeyRunLoop);</span><br><span class="line"><span class="keyword">if</span> (rl) <span class="keyword">return</span> rl;</span><br><span class="line"><span class="keyword">return</span> _CFRunLoopGet0(pthread_self());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<h5 id="_CFRunLoopGet0æ–¹æ³•">_CFRunLoopGet0æ–¹æ³•</h5></blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span><br><span class="line">*  è·å– runloop æ–¹æ³•</span><br><span class="line">*</span><br><span class="line">*  @param t çº¿ç¨‹å‚æ•°</span><br><span class="line">*</span><br><span class="line">*  @return è¿”å›è·å¾—çš„ runloop</span><br><span class="line">*/</span></span><br><span class="line">CF_EXPORT CFRunLoopRef _CFRunLoopGet0(<span class="keyword">pthread_t</span> t) &#123;</span><br><span class="line"><span class="comment">// æ”¾é”™æœºåˆ¶ï¼Œå¦‚æœçº¿ç¨‹æœªnilï¼Œåˆ™é»˜è®¤ä¸ºä¸»çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">if</span> (pthread_equal(t, kNilPthreadT)) &#123;</span><br><span class="line">t = <span class="keyword">pthread_main_t</span>hread_np();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è®¾ç½®äº’æ–¥é”</span></span><br><span class="line">__CFSpinLock(&amp;loopsLock);</span><br><span class="line"><span class="comment">// å¦‚æœå…¨å±€å­—å…¸ä¸ºç©º</span></span><br><span class="line"><span class="keyword">if</span> (!__CFRunLoops) &#123;</span><br><span class="line"><span class="comment">// å»é™¤äº’æ–¥é”</span></span><br><span class="line">__CFSpinUnlock(&amp;loopsLock);</span><br><span class="line"><span class="comment">// åˆ›å»ºå­—å…¸</span></span><br><span class="line">CFMutableDictionaryRef dict = CFDictionaryCreateMutable(kCFAllocatorSystemDefault, <span class="number">0</span>, NULL, &amp;kCFTypeDictionaryValueCallBacks);</span><br><span class="line"><span class="comment">// åˆ›å»º ä¸»çº¿ç¨‹çš„ mainLoop</span></span><br><span class="line">CFRunLoopRef mainLoop = __CFRunLoopCreate(<span class="keyword">pthread_main_t</span>hread_np());</span><br><span class="line"><span class="comment">// ä¿å­˜ mainLoop åˆ°å­—å…¸ä¸­ï¼š key ä¸ºçº¿ç¨‹ï¼Œvalueä¸ºmainLoop</span></span><br><span class="line">CFDictionarySetValue(dict, pthreadPointer(<span class="keyword">pthread_main_t</span>hread_np()), mainLoop);</span><br><span class="line"><span class="comment">// ä½¿ç”¨ dict è®¾ç½®å…¨å±€å­—å…¸__CFRunLoops</span></span><br><span class="line"><span class="keyword">if</span> (!OSAtomicCompareAndSwapPtrBarrier(NULL, dict, (<span class="keyword">void</span> * <span class="keyword">volatile</span> *)&amp;__CFRunLoops)) &#123;</span><br><span class="line"><span class="comment">// é‡Šæ”¾ dict çš„å†…å­˜</span></span><br><span class="line">CFRelease(dict);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å†…å­˜ç®¡ç†ï¼Œé‡Šæ”¾mainLoop</span></span><br><span class="line">CFRelease(mainLoop);</span><br><span class="line"><span class="comment">// è®¾ç½®äº’æ–¥é”</span></span><br><span class="line">__CFSpinLock(&amp;loopsLock);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ ¹æ®çº¿ç¨‹ï¼Œä»å…¨å±€å­—å…¸ä¸­è·å– runloop</span></span><br><span class="line">CFRunLoopRef loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));</span><br><span class="line"><span class="comment">// å–æ¶ˆäº’æ–¥é”</span></span><br><span class="line">__CFSpinUnlock(&amp;loopsLock);</span><br><span class="line"><span class="comment">// å®¹é”™åˆ¤æ–­ï¼Œå¦‚æœè·å–çš„ runloop ä¸ºç©ºï¼Œåˆ™åˆ›å»ºæ–°çš„ runloop</span></span><br><span class="line"><span class="keyword">if</span> (!loop) &#123;</span><br><span class="line"><span class="comment">// åˆ›å»ºæ–°çš„ runloop</span></span><br><span class="line">CFRunLoopRef newLoop = __CFRunLoopCreate(t);</span><br><span class="line"><span class="comment">// äº’æ–¥é”</span></span><br><span class="line">__CFSpinLock(&amp;loopsLock);</span><br><span class="line"><span class="comment">// å› ä¸ºä¹‹å‰å¯¹äº’æ–¥é”è¿›è¡Œå–æ¶ˆï¼Œæ‰€ä»¥å†æ¬¡æ·»åŠ äº’æ–¥é”åï¼Œä¸ºä¿è¯æ•°æ®å‡†ç¡®æ€§ï¼Œå†æ¬¡æ ¹æ®çº¿ç¨‹å‚æ•°ï¼Œä»å…¨å±€å­—å…¸ä¸­è·å– runloop</span></span><br><span class="line">loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));</span><br><span class="line"><span class="comment">// å¦‚æœå…¨å±€å­—å…¸ä¸­çš„ runloop æœ€æ–°å€¼ä»ä¸ºç©º</span></span><br><span class="line"><span class="keyword">if</span> (!loop) &#123;</span><br><span class="line"><span class="comment">// ä½¿ç”¨æ–°çš„ runloop å¹¶æ›´æ–°å…¨å±€å­—å…¸</span></span><br><span class="line">CFDictionarySetValue(__CFRunLoops, pthreadPointer(t), newLoop);</span><br><span class="line">loop = newLoop;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// don't release run loops inside the loopsLock, because CFRunLoopDeallocate may end up taking it</span></span><br><span class="line"><span class="comment">// å»é™¤äº’æ–¥é”</span></span><br><span class="line">__CFSpinUnlock(&amp;loopsLock);</span><br><span class="line"><span class="comment">// é‡Šæ”¾å†…å­˜</span></span><br><span class="line">CFRelease(newLoop);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ³¨å†Œçº¿ç¨‹ä¸runloopçš„å¯¹åº”å…³ç³»</span></span><br><span class="line"><span class="comment">// ç½‘ä¸Šèµ„æ–™å¯¹ä¸‹é¢çš„ä»£ç è§£é‡Šä¸ºæ³¨å†Œä¸€ä¸ªå›è°ƒæ–¹æ³•ï¼Œæ˜¯é”™è¯¯çš„</span></span><br><span class="line"><span class="keyword">if</span> (pthread_equal(t, pthread_self())) &#123;</span><br><span class="line"><span class="comment">// __CFTSDKeyRunLoop           : æšä¸¾å¸¸é‡ï¼Œæ•°å€¼ä¸º10ï¼Œåœ¨ TSD è¡¨ä¸­æ ‡è¯†å½“å‰çº¿ç¨‹</span></span><br><span class="line"><span class="comment">// __CFTSDKeyRunLoopCntr  ï¼šæšä¸¾å¸¸é‡ï¼Œæ•°å€¼ä¸º11ï¼Œåœ¨ TSD è¡¨ä¸­æ ‡è¯†ä¸»çº¿ç¨‹</span></span><br><span class="line"><span class="comment">// _CFSetTSD çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œæ•°å€¼ä¸èƒ½å¤§äº70ï¼Œå¦åˆ™ä¼šæŠ¥é”™ï¼Œè¿™ä¸ªå‡½æ•°ä¸»è¦ç”¨äºè®¾ç½®çº¿ç¨‹å†…éƒ¨çš„æ•°æ®</span></span><br><span class="line"><span class="comment">// TSDè¡¨ä¸­ï¼Œæ¯ä¸ªæ•°æ®éƒ½éƒ½éœ€è¦é…ç½®é”€æ¯å™¨å¯¹è±¡</span></span><br><span class="line">_CFSetTSD(__CFTSDKeyRunLoop, (<span class="keyword">void</span> *)loop, NULL);</span><br><span class="line"><span class="keyword">if</span> (<span class="number">0</span> == _CFGetTSD(__CFTSDKeyRunLoopCntr)) &#123;</span><br><span class="line">_CFSetTSD(__CFTSDKeyRunLoopCntr, (<span class="keyword">void</span> *)(PTHREAD_DESTRUCTOR_ITERATIONS-<span class="number">1</span>), (<span class="keyword">void</span> (*)(<span class="keyword">void</span> *))__CFFinalizeRunLoop);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> loop;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/2015/08/15/ä½¿ç”¨KVOç›‘å¬æ•°ç»„çš„å°æŠ€å·§/" id="article-nav-older" class="article-nav-link-wrap">
      <div class="article-nav-title">ä½¿ç”¨KVOç›‘å¬æ•°ç»„çš„å°æŠ€å·§</div>
      <strong class="article-nav-caption">></strong>
    </a>
  
</nav>

  
</article>


<div class="share">
	<!-- JiaThis Button BEGIN -->
	<div class="jiathis_style">
		<span class="jiathis_txt">åˆ†äº«åˆ°ï¼š</span>
		<a class="jiathis_button_tsina"></a>
		<a class="jiathis_button_cqq"></a>
		<a class="jiathis_button_douban"></a>
		<a class="jiathis_button_weixin"></a>
		<a class="jiathis_button_tumblr"></a>
		<a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jtico jtico_jiathis" target="_blank"></a>
	</div>
	<script type="text/javascript" src="http://v3.jiathis.com/code/jia.js?uid=1405949716054953" charset="utf-8"></script>
	<!-- JiaThis Button END -->
</div>



<div class="duoshuo">
	<!-- å¤šè¯´è¯„è®ºæ¡† start -->
	<div class="ds-thread" data-thread-key="Runloopå†…éƒ¨åˆ†äº«" data-title="Runloopå†…éƒ¨åˆ†äº«" data-url="http://yoursite.com/2016/04/11/Runloopå†…éƒ¨åˆ†äº«/"></div>
	<!-- å¤šè¯´è¯„è®ºæ¡† end -->
	<!-- å¤šè¯´å…¬å…±JSä»£ç  start (ä¸€ä¸ªç½‘é¡µåªéœ€æ’å…¥ä¸€æ¬¡) -->
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"true"};
	(function() {
		var ds = document.createElement('script');
		ds.type = 'text/javascript';ds.async = true;
		ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
		ds.charset = 'UTF-8';
		(document.getElementsByTagName('head')[0] 
		 || document.getElementsByTagName('body')[0]).appendChild(ds);
	})();
	</script>
	<!-- å¤šè¯´å…¬å…±JSä»£ç  end -->
</div>




</div>
      <footer id="footer">
  <div class="outer">
    <div id="footer-info">
    	<div class="footer-left">
    		&copy; 2016 Alexcai
    	</div>
      	<div class="footer-right">
      		<a href="http://hexo.io/" target="_blank">Hexo</a>  Theme <a href="https://github.com/litten/hexo-theme-yilia" target="_blank">Yilia</a> by Litten
      	</div>
    </div>
  </div>
</footer>
    </div>
    
  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css" type="text/css">


<script>
	var yiliaConfig = {
		fancybox: true,
		mathjax: true,
		animate: true,
		isHome: false,
		isPost: true,
		isArchive: false,
		isTag: false,
		isCategory: false,
		open_in_new: false
	}
</script>
<script src="http://7.url.cn/edu/jslib/comb/require-2.1.6,jquery-1.9.1.min.js" type="text/javascript"></script>
<script src="/js/main.js" type="text/javascript"></script>






<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>


  </div>
</body>
</html>